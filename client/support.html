<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Support Concierge</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,600;9..144,700&family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f7f4ee;
      --bg-soft: #fffdf8;
      --ink: #1f2933;
      --ink-soft: #4b5563;
      --line: #d9d7d1;
      --card: #fffefb;
      --accent: #0f766e;
      --accent-strong: #115e59;
      --accent-soft: #e7faf5;
      --shadow: 0 14px 36px rgba(23, 32, 43, 0.09);
      --radius: 14px;
      --font-body: "Space Grotesk", "Work Sans", system-ui, -apple-system, Segoe UI, sans-serif;
      --font-display: "Fraunces", Georgia, serif;
    }
    body { font-family: var(--font-body); margin: 0; background: var(--bg); color: var(--ink); }
    .layout { display: flex; min-height: 100vh; }
    .chat-pane { flex: 1 1 auto; min-width: 0; padding: 16px; display: grid; grid-template-rows: auto 1fr auto; gap: 10px; }
    .panel { background: var(--card); border: 1px solid var(--line); border-radius: 12px; box-shadow: var(--shadow); }
    .header { padding: 14px; }
    .messages { padding: 12px; overflow: auto; display: grid; gap: 8px; }
    .msg { max-width: 85%; padding: 10px 12px; border-radius: 12px; white-space: pre-wrap; line-height: 1.4; }
    .msg.user { justify-self: end; background: linear-gradient(120deg, var(--accent) 0%, var(--accent-strong) 100%); color: #fff; }
    .msg.assistant { justify-self: start; background: var(--bg-soft); color: var(--ink); border: 1px solid var(--line); }
    .composer { padding: 10px; display: grid; gap: 8px; }
    .row { display: flex; gap: 8px; align-items: center; }
    textarea, input, button { font: inherit; border: 1px solid var(--line); border-radius: 10px; padding: 10px; background: var(--card); color: var(--ink); }
    textarea { min-height: 72px; resize: vertical; }
    button { cursor: pointer; }
    .meta { font-size: 12px; color: var(--ink-soft); }
    .cite-pane { width: 340px; flex: 0 0 auto; padding: 16px; border-left: 1px solid var(--line); background: var(--bg-soft); display: grid; grid-template-rows: auto 1fr; gap: 10px; resize: horizontal; overflow: auto; min-width: 220px; max-width: 60vw; }
    .cites { overflow: auto; display: grid; gap: 8px; }
    .cite { background: var(--card); border: 1px solid var(--line); border-radius: 10px; padding: 10px; }
    .cite .file { font-weight: 600; }
    .status { font-size: 12px; color: var(--ink-soft); }
    @media (max-width: 980px) { .layout { flex-direction: column; } .cite-pane { width: auto; resize: none; border-left: 0; border-top: 1px solid var(--line); max-width: none; } }
  </style>
</head>
<body>
  <div class="layout">
    <section class="chat-pane">
      <div class="panel header">
        <h1 style="margin:0">Support Concierge</h1>
        <div class="meta">Friendly, grounded help for features, API usage, and troubleshooting. Answers include citations.</div>
      </div>

      <div id="messages" class="panel messages">
        <div class="msg assistant">Hi, Iâ€™m your Support Concierge. Ask me anything about this app, APIs, setup, or troubleshooting.</div>
      </div>

      <div class="panel composer">
        <div class="row">
          <input id="api-key" type="password" placeholder="Optional x-api-key (if not logged in)" style="flex:1" />
          <button id="clear" type="button">Clear</button>
        </div>
        <textarea id="message" placeholder="Example: How do I attach knowledge packs to a persona chat or use the Formal Debate Template?"></textarea>
        <div class="row">
          <button id="send" type="button">Send</button>
          <span id="status" class="status">Ready.</span>
        </div>
      </div>
    </section>

    <aside class="cite-pane">
      <div>
        <h2 style="margin:0">Citations</h2>
        <div class="meta">Latest reply sources</div>
      </div>
      <div id="citations" class="cites"></div>
    </aside>
  </div>

  <script>
    const byId = (id) => document.getElementById(id);
    const messagesEl = byId('messages');
    const citationsEl = byId('citations');

    function applyTheme(theme) {
      if (!theme || typeof theme !== 'object') return;
      const root = document.documentElement;
      const vars = theme.variables && typeof theme.variables === 'object' ? theme.variables : {};
      Object.entries(vars).forEach(([key, value]) => {
        if (!key || typeof value === 'undefined') return;
        root.style.setProperty(String(key), String(value));
      });
      const typography = theme.typography && typeof theme.typography === 'object' ? theme.typography : {};
      if (typography.body) root.style.setProperty('--font-body', String(typography.body));
      if (typography.display) root.style.setProperty('--font-display', String(typography.display));
    }

    async function loadTheme() {
      try {
        const res = await fetch('/theme', { credentials: 'include' });
        if (!res.ok) return;
        const payload = await res.json().catch(() => ({}));
        applyTheme(payload?.data?.theme || payload?.theme || null);
      } catch {
        // ignore
      }
    }

    function addMessage(role, text) {
      const div = document.createElement('div');
      div.className = `msg ${role}`;
      div.textContent = text;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function citationHref(citation) {
      const file = String(citation?.file || '').trim();
      if (!file) return '#';
      if (file === 'README.md') return '/docs/README.md';
      if (file.startsWith('docs/')) return `/docs/${encodeURI(file.slice(5))}`;
      return '#';
    }

    function truncateExcerpt(text, max = 180) {
      const compact = String(text || '').replace(/\s+/g, ' ').trim();
      if (compact.length <= max) return compact;
      return `${compact.slice(0, Math.max(0, max - 1)).trim()}...`;
    }

    function normalizeCitations(citations, limit = 6) {
      const seen = new Set();
      const rows = [];
      for (const c of Array.isArray(citations) ? citations : []) {
        const file = String(c.file || '').trim() || 'doc';
        const heading = String(c.heading || '').trim() || 'section';
        const key = `${file}::${heading}`.toLowerCase();
        if (seen.has(key)) continue;
        seen.add(key);
        rows.push({
          file,
          heading,
          href: citationHref(c),
          excerpt: truncateExcerpt(c.excerpt || '', 180)
        });
        if (rows.length >= limit) break;
      }
      return rows;
    }

    function renderCitations(citations) {
      citationsEl.innerHTML = '';
      const normalized = normalizeCitations(citations);
      if (!normalized.length) {
        citationsEl.innerHTML = '<div class="cite">No citations available for this reply.</div>';
        return;
      }
      for (const c of normalized) {
        const div = document.createElement('div');
        div.className = 'cite';
        const safeExcerpt = String(c.excerpt || '').replace(/</g, '&lt;');
        div.innerHTML = `<div class="file"><a href="${c.href}" target="_blank" rel="noopener">${c.file}</a></div><div>${c.heading}</div><div class="meta">${safeExcerpt}</div>`;
        citationsEl.appendChild(div);
      }
    }

    async function send() {
      const key = byId('api-key').value.trim();
      const message = byId('message').value.trim();
      if (!message) {
        byId('status').textContent = 'Message is required.';
        return;
      }

      addMessage('user', message);
      byId('message').value = '';
      byId('status').textContent = 'Support Concierge is thinking...';

      try {
        const headers = { 'Content-Type': 'application/json' };
        if (key) headers['x-api-key'] = key;

        const res = await fetch('/api/support/messages', {
          method: 'POST',
          credentials: 'include',
          headers,
          body: JSON.stringify({ message })
        });
        const payload = await res.json().catch(() => ({}));
        if (!res.ok || !payload.ok) {
          throw new Error(payload?.error?.message || 'Support request failed');
        }

        addMessage('assistant', String(payload.data?.reply || '(empty reply)'));
        renderCitations(payload.data?.citations || []);
        byId('status').textContent = 'Reply ready.';
      } catch (error) {
        addMessage('assistant', `I hit an issue processing that request: ${error.message}`);
        byId('status').textContent = `Failed: ${error.message}`;
      }
    }

    byId('send').addEventListener('click', send);
    byId('message').addEventListener('keydown', (event) => {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        send();
      }
    });
    byId('clear').addEventListener('click', () => {
      messagesEl.innerHTML = '<div class="msg assistant">New support conversation started. How can I help?</div>';
      citationsEl.innerHTML = '';
      byId('status').textContent = 'Cleared.';
    });

    loadTheme();
  </script>
</body>
</html>
